{{- if .Values.pgbouncer.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-pgbouncer-secret
  labels:
    {{- include "pvpipe.labels" . | nindent 4 }}
    app.kubernetes.io/component: pgbouncer
type: Opaque
stringData:
  # Extract PostgreSQL connection details from DATABASE_URL
  {{- if and .Values.env .Values.env.DATABASE_URL }}
  {{- $dbUrl := .Values.env.DATABASE_URL }}
  {{- if contains "postgresql://" $dbUrl }}
  {{- $parsed := regexSplit "[@:/]+" (trimPrefix "postgresql://" $dbUrl) -1 }}
  {{- if ge (len $parsed) 5 }}
  postgres-user: {{ index $parsed 0 | quote }}
  postgres-password: {{ index $parsed 1 | quote }}
  postgres-host: {{ index $parsed 2 | quote }}
  postgres-database: {{ index $parsed 4 | quote }}
  {{- end }}
  {{- end }}
  {{- else }}
  # Default values when DATABASE_URL is not set
  postgres-user: "postgres"
  postgres-password: "password"
  postgres-host: "postgres"
  postgres-database: "postgres"
  {{- end }}
  # Generate userlist.txt for PgBouncer authentication
  userlist.txt: |
    {{- if and .Values.env .Values.env.DATABASE_URL }}
    {{- $dbUrl := .Values.env.DATABASE_URL }}
    {{- if contains "postgresql://" $dbUrl }}
    {{- $parsed := regexSplit "[@:/]+" (trimPrefix "postgresql://" $dbUrl) -1 }}
    {{- if ge (len $parsed) 2 }}
    # Main database user
    "{{ index $parsed 0 }}" "md5{{ index $parsed 1 | sha256sum | trunc 32 }}"
    {{- end }}
    {{- end }}
    {{- end }}
    {{- if and .Values.env .Values.env.DATABASE_URL_READONLY }}
    {{- $dbUrlReadonly := .Values.env.DATABASE_URL_READONLY }}
    {{- if contains "postgresql://" $dbUrlReadonly }}
    {{- $parsedReadonly := regexSplit "[@:/]+" (trimPrefix "postgresql://" $dbUrlReadonly) -1 }}
    {{- if ge (len $parsedReadonly) 2 }}
    # Read-only database user
    "{{ index $parsedReadonly 0 }}" "md5{{ index $parsedReadonly 1 | sha256sum | trunc 32 }}"
    {{- end }}
    {{- end }}
    {{- end }}
    # PgBouncer admin user
    "pgbouncer" "md5{{ printf "%s%s" "pgbouncer" "admin123" | sha256sum | trunc 32 }}"
{{- end }}