apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-secret
type: Opaque
data:
  {{- range $key, $value := .Values.env }}
  {{- if or (contains "SECRET" $key) (contains "CERT" $key) (contains "PASSWORD" $key) (contains "MASTER_KEY" $key) }}
  {{ $key }}: {{ $value | b64enc | quote }}
  {{- else if eq "DATABASE_URL" $key }}
  {{- if and $.Values.pgbouncer $.Values.pgbouncer.enabled }}
  # Original DATABASE_URL for PgBouncer to connect to PostgreSQL
  DATABASE_URL_ORIGINAL: {{ $value | b64enc | quote }}
  # Transformed DATABASE_URL for services to connect through PgBouncer
  {{- $pgbouncerUrl := include "pvpipe.pgbouncerDatabaseUrl" $ }}
  {{- if $pgbouncerUrl }}
  DATABASE_URL: {{ $pgbouncerUrl | b64enc | quote }}
  {{- else }}
  DATABASE_URL: {{ $value | b64enc | quote }}
  {{- end }}
  {{- else }}
  DATABASE_URL: {{ $value | b64enc | quote }}
  {{- end }}
  {{- else if eq "DATABASE_URL_READONLY" $key }}
  {{- if and $.Values.pgbouncer $.Values.pgbouncer.enabled }}
  # Original DATABASE_URL_READONLY for PgBouncer to connect to PostgreSQL
  DATABASE_URL_READONLY_ORIGINAL: {{ $value | b64enc | quote }}
  # Transformed DATABASE_URL_READONLY for services to connect through PgBouncer
  {{- $pgbouncerUrlReadonly := include "pvpipe.pgbouncerDatabaseUrlReadonly" $ }}
  {{- if $pgbouncerUrlReadonly }}
  DATABASE_URL_READONLY: {{ $pgbouncerUrlReadonly | b64enc | quote }}
  {{- else }}
  DATABASE_URL_READONLY: {{ $value | b64enc | quote }}
  {{- end }}
  {{- else }}
  DATABASE_URL_READONLY: {{ $value | b64enc | quote }}
  {{- end }}
  {{- end }}
  {{- end }}
  {{- if and .Values.meilisearch.enabled .Values.meilisearch.masterKey }}
  meilisearch-master-key: {{ .Values.meilisearch.masterKey | b64enc | quote }}
  {{- end }}
