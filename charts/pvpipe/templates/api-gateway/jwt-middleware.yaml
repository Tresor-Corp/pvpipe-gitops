{{- if and .Values.traefik.enabled .Values.traefik.middleware.jwt.enabled }}
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: {{ include "pvpipe.fullname" . }}-jwt-auth
  labels:
    {{- include "pvpipe.labels" . | nindent 4 }}
    app.kubernetes.io/component: traefik-middleware
spec:
  plugin:
    jwt:
      secret: {{ .Values.traefik.middleware.jwt.secret.existingSecret | default (printf "%s-jwt-secret" (include "pvpipe.fullname" .)) }}
      secretKey: {{ .Values.traefik.middleware.jwt.secret.key | default "jwt-secret" }}
      algorithm: {{ .Values.traefik.middleware.jwt.algorithm | default "HS256" }}
      {{- if .Values.traefik.middleware.jwt.issuer }}
      issuer: {{ .Values.traefik.middleware.jwt.issuer }}
      {{- end }}
      {{- if .Values.traefik.middleware.jwt.audience }}
      audience: {{ .Values.traefik.middleware.jwt.audience }}
      {{- end }}
      {{- if .Values.traefik.middleware.jwt.sources }}
      jwtSources:
        {{- toYaml .Values.traefik.middleware.jwt.sources | nindent 8 }}
      {{- end }}
      {{- if .Values.traefik.middleware.jwt.requiredClaims }}
      payloadFields:
        {{- toYaml .Values.traefik.middleware.jwt.requiredClaims | nindent 8 }}
      {{- end }}
      {{- if .Values.traefik.middleware.jwt.forwardHeaders }}
      jwtHeaders:
        {{- range .Values.traefik.middleware.jwt.forwardHeaders }}
        {{ .header }}: {{ .claim }}
        {{- end }}
      {{- end }}
{{- end }}